{% extends 'base.html.twig' %}

{% block title %}Register{% endblock %}

{% block body %}

    {{ form_start(registrationForm) }}

    <div class="background-img"></div>
    <div class="body-page register" style="margin-top: 5%">
        <div class="container text-center body-content ">
            <img class="logo-login" src="{{asset('assets/images/logo_suivi.png')}}" alt="logo" id="logo">
            <h3 class="main-title mb-4">{% trans %}Register Patient{% endtrans %}</h3>
            <form role="form" class="form-horizontal" id="register-form">
                <input type="hidden" id="patient-enfant" value={{ statsService.typePatientEnfant }} />
                <input type="hidden" id="patient-adulte" value={{ statsService.typePatientAdulte }} />
                <div class="row form-group">
                    <div class="col-lg-6">
                        {{ form_widget(registrationForm.lastname, {'attr': {'class': 'form-control', 'placeholder': 'Lastname', "minlength":"3"}}) }}
                    </div>
                    <div class="col-lg-6">
                        {{ form_widget(registrationForm.firstname, {'attr': {'class': 'form-control', 'placeholder': 'firstname', "minlength":"3" }}) }}
                    </div>
                </div>
                <div class="row form-group">
                    <div class="col-lg-6">
                        {{ form_widget(registrationForm.type_patient, {'attr': {'class': 'form-control', 'placeholder': 'Patient type'}})}}

                    </div>
                    <div class="col-lg-6">
                        {{ form_widget(registrationForm.sexe, {'attr': {'class': 'form-control', 'placeholder': 'Gender'}}) }}

                    </div>

                </div>
                <div class="row form-group">
                    <div class="col-lg-6">
                        {{ form_widget(registrationForm.date_naissance, {'attr': {'class': 'form-control', 'placeholder': 'Date of Birth'}}) }}
                    </div>
                    <div class="col-lg-6">
                        {{ form_widget(registrationForm.lieu_naissance, {'attr': {'class': 'form-control', 'placeholder': 'Place of birth', "minlength":"3"}}) }}
                    </div>
                </div>

                <div class="row form-group">
                    <div class="col-lg-6">
                        {{ form_widget(registrationForm.country , {'attr': {'class': 'form-control', 'placeholder': 'country', "minlength":"3"}}) }}
                    </div>
                    <div class="col-lg-6">
                        <select class="form-control" id="city" name="city" >
                            <option value="" selected>Select your City</option>
                        </select>
                    </div>
                </div>

                <div class="row form-group">
                    <div class="col-lg-6">
                        {{ form_widget(registrationForm.address, {'attr': { 'class': 'form-control form-textarea', 'placeholder': 'Address', 'rows':'4', "minlength":"3" }}) }}
                    </div>
                    <div class="col-lg-6">
                        <div class=" pt-2 pb-2">
                            {{ form_widget(registrationForm.email, {'attr': {'class': 'form-control', 'placeholder': 'Your email address', "minlength":"3"}})}}
                        </div>
                        <div class=" pt-2 pb-2">
                            {{ form_widget(registrationForm.username, {'attr': {'class': 'form-control', 'placeholder': 'Your username', "minlength":"3"}}) }}
                        </div>
                    </div>

                </div>
                <div class="row form-group" id="form-parent">
                    <div class="col-md-12">
                        {{ form_widget(registrationForm.namedaddy, {'attr': {'class': 'form-control mb-3', 'placeholder': 'name of  Father'}}) }}
                    </div>
                    <div class="col-md-12">
                        {{ form_widget(registrationForm.namemonther, {'attr': {'class': 'form-control mb-3', 'placeholder': 'mother name'}}) }}
                    </div>
                </div>
                <div class="row form-group">
                    <div class="col-lg-6">
                            {{ form_widget(registrationForm.plainPassword, {'attr': {'class': 'form-control', 'placeholder': 'Password', "minlength":"12", "matchPassword": 'true' }}) }}

                    </div>
                    <div class="col-lg-6">
                        <input type="button" id="tel" value="+33" style="position: absolute; width:45px; height: 38px; left: 15px; border: 1px solid #ced4da;border-radius: .25rem;">
                        {{ form_widget(registrationForm.phone, {'attr': {'class': 'form-control', 'placeholder': 'Phone', "minlength":"9"}}) }}
                    </div>
                </div>
                <div class="row form-group ml-3" id="form" >
                    <label> Enceinte</label>
                    <div class="row form-group ">
                        {{ form_widget(registrationForm.enceinte)  }}
                    </div>
                </div>


                <button type="submit" class="btn btn-info button-login mb-3" id="submit_register">
                    S'inscrire
                </button>

                {{ form_end(registrationForm) }}
        </div>
    </div>
{% endblock %}
{% block javascripts %}
    {{ parent() }}
    <script>

        $('#submit_register').click(function(e) {
            if (!$('#register-form').valid()) {
                e.preventDefault();
                return false;
            }
        });



        $("#register-form").validate()
        function getRndInteger(min = 10000, max= 100000) {
            return Math.floor(Math.random() * (max - min + 1) ) + min;
        }

        function createUsername()  {

            $('#registration_form_date_naissance').on('change',function () {

                var date = $('#registration_form_date_naissance').val();
                var dat = new Date(date);
                var mois = dat.getMonth();
                if(mois<9){
                    var moi = ('0' + (dat.getMonth() + 1) );
                }else{
                    var moi = dat.getMonth() + 1;
                }
                var ann = dat.getFullYear() ;
                if (ann<2000){
                    var anne = dat.getYear();
                }else {
                    var anne = dat.getYear()-100;
                }
                var jou = dat.getDate();
                if(jou<10){
                    var jour = ('0'+ (dat.getDate()));
                }else{
                    var jour = dat.getDate();
                }
                var sexe = $('#registration_form_sexe').val().substring(0,1);

                var username = sexe + anne + moi + jour + getRndInteger() ;
                $.ajax({
                    url: "{{ path('check_username') }}",
                    type: 'POST',
                    data: {
                        'username': username,
                    },
                    dataType: "json",
                    success: (data) => {
                        console.log(data);
                        if (data.status == "OK"){
                            $('#registration_form_username').val(username);
                        }else {
                            createUsername();
                        }
                    },
                    error: (e) => {
                        console.log(error);
                    }
                }).done(() => {
                });
            });
        } 


        $.validator.addMethod(
            "matchPassword",
            function(value) {
                let res = false;
                var pswd=   $("#registration_form_plainPassword").val();
                if(pswd.match(/^.*(?=.{12,})(?=.*\d)(?=.*[a-z])(?=.*[A-Z])(?=.*[\x20-\x2F|\x3A-\x40|\x5B-\x60|\x7B-\x7E]).*$/)) {
                    res = true;
                }
                return res;
            },
            " Le mot de passe doit comporter des majuscules, des minuscules, au moins 1 chiffre et au moins un caractère."
        );

        jQuery.extend(jQuery.validator.messages, {
            required: "Ce champ est obligatoire, veuillez le  remplir.",
            remote: "votre message",
            email: "Veuillez entrer un adresse email valide ",
            url: "Vous devriez entrer un lien comme http://exemple.com",
            date: "Veuillez fournir un date",
            dateISO: "votre message",
            number: "Veuillez entre un nombre",
            digits: "votre message",
            creditcard: "Veuillez entrer un numero de carte valide",
            equalTo: "votre message",
            accept: "votre message",
            maxlength: jQuery.validator.format("La valeur maximale pour ce champ est de {0} caractéres."),
            minlength: jQuery.validator.format("La valeur minimale pour ce champ est de {0} caractéres."),
            rangelength: jQuery.validator.format("votre message  entre {0} et {1} caractéres."),
            range: jQuery.validator.format("votre message  entre {0} et {1}."),
            max: jQuery.validator.format("votre message  inférieur ou égal à {0}."),
            min: jQuery.validator.format("votre message  supérieur ou égal à {0}."),
            iban: "L'IBAN saisi n'est pas valide"
        });

        jQuery('label.error').append('<div class="arrow-error"></div>');

        $(document).ready(function () {
            $('#form-parent').css("display", "none");
            $('#form').css("display", "none");
            $('#registration_form_username').attr("readonly", "true");

            function cb(d) {
                $('#registration_form_date_naissance').datepicker({
                    format: 'dd/mm/yyyy',
                    autoclose: true,
                    endDate: d,
                });
            }

            
            $("#registration_form_type_patient").on('change', function (e) {
                loadDatePicker($("#registration_form_type_patient").val());

                if ($("#registration_form_type_patient").val() == $('#patient-enfant').val()){
                    $('#form-parent').css("display", "block");
                }else {
                    $('#form-parent').css("display", "none");
                }
                
                $("#registration_form_sexe").on('change', function (e) {
                    if ($("#registration_form_type_patient").val() == $('#patient-adulte').val() && $("#registration_form_sexe").val() == "Feminin" ){
                        $('#form').css("display", "flex");
                    }else {
                        $('#form').css("display", "none");
                    }
                });
            });

            function loadDatePicker(type){
                if(type == $('#patient-adulte').val()){
                    var past = new Date();
                    past.setDate(past.getDate() - (16 * 365));
                    $('#registration_form_date_naissance').datepicker("refresh");
                    $('#registration_form_date_naissance')
                        .datepicker("setEndDate", past)
                            .datepicker("update",past);
                }else{
                    $('#registration_form_date_naissance').datepicker("refresh");
                    $('#registration_form_date_naissance').datepicker("setEndDate", new Date()).datepicker("update", new Date());
                }
                
            }
            

            $('#registration_form_firstname').on('keyup', createUsername);
            $('#registration_form_lastname').on('keyup', createUsername);

            $('#registration_form_country').on('change',function () {
                var idcountry = $('#registration_form_country option:selected').val();
                $.ajax({
                    method: "POST",
                    url: "{{ path('country') }}",
                    data: {id: idcountry},
                    success: function(response){
                        $('#city').empty();
                        $.each(response, function(index,element) {
                            $('#city').append('<option value="'+ element.id +'" selected="selected">'+ element.nameCity +' </option>');

                        });
                    }
                });
                $.ajax({
                    method: "POST",
                    url: "{{ path('num') }}",
                    data: {id: idcountry},
                    success: function(response){
                        $('#tel').empty();
                        $.each(response, function(index,element) {
                            $('#tel').val(element.phoneindic);
                        });
                    }
                });
            });
        });



    </script>
{% endblock %}
